<html>
<head>
    <meta charset="utf-8" />
	<link href="C:/Users/Administrator/Desktop/html/bootstrap-4.1.3-dist/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
	 <script type="text/javascript" src="/C:/Users/Administrator/Desktop/html/jquery.min.js"></script>
</head>
	
<body>
    <div style="text-align:center">
        <h3 style="padding-bottom:50px">商品详情</h3>
		<div>
            <label style="color:red" id = "promoStatus">秒杀开始时间</label>
            
                <label style="color:red" type="text" placeholder="秒杀开始时间" name="promoStartTime" id="promoStartTime"></label>
            
        </div>
        <div>
            <label>商品名</label>
            
                <label type="text" placeholder="商品名" name="title" id="title"></label>
            
        </div>
		<div>
            <label>商品描述</label>
            
                <label type="text" placeholder="商品描述" name="description" id="description"></label>
            
        </div>
		<div id = "priceContainer">
            <label>价格</label>
            
                <label type="text" placeholder="价格" name="price" id="price"></label>
            
        </div>
		<div id="promoPriceContainer">
        <label style="color:red">秒杀价格</label>
            
                <label type="text" placeholder="价格" name="promoPrice" id="promoPrice" style="color:red"></label>
            
        </div>
		<div>
            <label>图片</label>
            
                <img type="text" style="width:200px;height=auto" id="imgurl"/>
            
        </div>
		<div>
            <label>库存</label>
            
                <label type="text" placeholder="库存" name="stock" id="stock"></label>
            
        </div>
		<div>
            <label>销量</label>
            
                <label type="text" placeholder="销量" name="sales" id="sales"></label>
            
        </div>
		<div>
            <button id = "createOrder" type="submit">下单</button>
        </div>
    </div>
</body>
<script>
var item = {};
    jQuery(document).ready(function(){
	
	$("#createOrder").on("click",function(){
		      $.ajax({
                type:"POST",
				contentType:"application/x-www-form-urlencoded",
                url:"http://localhost:8089/order/createOrder",
                data:{
                    "itemId":item.id,	
					"amount":1,
					"promoId":item.promoId
                },
				xhrFields:{withCredentials:true},
                success:function(data){
                    if(data.status == "success"){
						alert("下单成功");
						window.location.reload();
                    }else{
                        alert("下单失败，原因为"+data.data.errMsg);
						if(data.data.errCode == 20002){
							window.location.href="login.html"
						}
                    }
                },
                error:function(data){
                    alert("下单失败，原因为"+data.responseText);
                },
            });
	})
			
            $.ajax({
                type:"GET",
                url:"http://localhost:8089/item/get",
                data:{
                    "id":getQueryString("id"),					
                },
				xhrFields:{withCredentials:true},
                success:function(data){
                    if(data.status == "success"){
                       item = data.data;
					   loadDom();
					   setInterval(loadDom,1000);
                    }else{
                        alert("获取详情失败，原因为"+data.data.errMsg);
                    }
                },
                error:function(data){
                    alert("获取详情失败失败，原因为"+data.responseText);
                },
            });
        })
		function loadDom(){
			$("#title").text(item.title);
			$("#description").text(item.description);
			$("#price").text(item.price);
			$("#stock").text(item.stock);
			$("#sales").text(item.sales);
			$("#imgurl").attr("src",item.imgUrl);
			if(item.promoStatus == 1){
				var startTime = item.startDate.replace(new RegExp("-","gm"),"/");
				startTime = (new Date(startTime)).getTime();
				var nowTime = Date.parse(new Date());
				var delta = (startTime - nowTime)/1000;
				if(delta <= 0){
					item.promoStatus == 2;
					loadDom();
				}
				// 未开始  展示开始时间和价格
				$("#promoStartTime").text("秒杀活动将于"+item.startDate+"开始,倒计时："+delta+"秒");
				$("#promoPrice").text(item.promoPrice);
				// 禁止下单
				$("#createOrder").attr("disabled",true);
			}else if(item.promoStatus == 2){
				// 正在进行中
				$("#promoStartTime").text("秒杀正在进行中");
				$("#promoPrice").text(item.promoPrice);
				$("#createOrder").attr("disabled",false);
				$("#priceContainer").hide();
			}
		}
		function getQueryString(name) { 
			var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i"); 
			var r = window.location.search.substr(1).match(reg); 
			if (r != null) return unescape(r[2]); return null; 
		} 

</script>
</html>